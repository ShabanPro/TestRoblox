<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Easy P2P Chat</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
#chat { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: .5rem; }
input, button { padding: .4rem; }
</style>
</head>
<body>
<h2>Easy P2P Chat</h2>
<p>Room: <input id="room" placeholder="room name"> <button id="join">Join</button></p>
<div id="chat"></div>
<p><input id="msg" placeholder="Type message..." style="width:80%"> <button id="send">Send</button></p>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pc, channel;
const chat = document.getElementById('chat');
const log = m => { chat.innerHTML += `<div>${m}</div>`; chat.scrollTop = chat.scrollHeight; };

document.getElementById('join').onclick = async () => {
  const room = document.getElementById('room').value;
  if (!room) return alert("Enter room name");
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
  channel = pc.createDataChannel('chat');
  channel.onmessage = e => log("Peer: " + e.data);
  channel.onopen = () => log("Connected!");

  pc.onicecandidate = e => {
    if (e.candidate) db.ref(room + "/candidates/" + Date.now()).set(e.candidate.toJSON());
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref(room).set({ offer });

  db.ref(room + "/answer").on("value", async snap => {
    const ans = snap.val();
    if (ans && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(new RTCSessionDescription(ans));
    }
  });

  db.ref(room + "/candidates").on("child_added", async snap => {
    const cand = snap.val();
    if (cand) await pc.addIceCandidate(new RTCIceCandidate(cand));
  });

  // Listen for incoming data channel (if you join second)
  pc.ondatachannel = e => {
    channel = e.channel;
    channel.onmessage = ev => log("Peer: " + ev.data);
    channel.onopen = () => log("Connected!");
  };
};

document.getElementById('send').onclick = () => {
  const m = document.getElementById('msg').value;
  if (channel && channel.readyState === 'open') {
    channel.send(m);
    log("You: " + m);
    document.getElementById('msg').value = '';
  }
};
</script>
</body>
</html>
